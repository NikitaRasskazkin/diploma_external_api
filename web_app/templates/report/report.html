{% extends 'base/base.html' %}
{% load static %}

{% block 'title' %}Отчёт{% endblock %}

{% block 'content' %}

<style>
    .source-text {
        border-radius: 5px;
        
    }
</style>

<div class="m-3 ms-5 me-5">
    <h5 id="title" class="mb-3"></h5>
    <div id="source-text" class="card p-3">

    </div>
</div>
{% endblock %}

{% block 'script' %}
<script>
    class ReportManager {
        constructor() {
            this.__timer_id = null;
            this.__update_id = 0;
            this.__is_completed = false;
        }

        startAutoUpdate(interval=1500) {
            this.update();
            this.__timer_id = setInterval(this.update.bind(this), interval);
        }

        stopAutoUpdate() {
            clearInterval(this.__timer_id);
        }

        async update() {
            if (this.__is_completed) {
                return;
            }
            const cur_update_id = ++this.__update_id;
            const report = await this.__loadReportInfo();
            if (cur_update_id !== this.__update_id) {
                return;
            }
            this.__is_completed = report.status === 'COMPLETED' || report.status === 'ERROR';
            if (report.status === 'COMPLETED') {
                $('#source-text').html(report.text);
            } else {
                $('#source-text').html(report.text);
            }
            let title;
            switch (report.status) {
                case 'WAITING': title = `В очереди на формирование отчёта: ${report.queue_place}`; break;
                case 'IN_PROCESS': title = `Идёт формирование отчёта`; break;
                case 'ERROR': title = `При формировании отчёта произошла ошибка`; break;
                default: title = 'Отчёт';
            }
            $('#title').html(title);
            if (this.__is_completed) this.stopAutoUpdate();
        }

        async __loadReportInfo() {
            const response = await $.ajax({
                type: "GET",
                url: "{% url 'report:detail' report.id %}",
            });
            return response.data;
        }
    }


    const report_manager = new ReportManager();
    report_manager.startAutoUpdate();
</script>
{% endblock %}
